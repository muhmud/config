#!/bin/bash

HEAD_PHONES=CC:98:8B:F5:0A:AE

coproc bluetoothctl

if [[ "$1" == "connect" ]]; then
  echo -e "disconnect $HEAD_PHONES" >&${COPROC[1]}
  sleep 3;
  
  echo -e "scan on" >&${COPROC[1]}
  sleep 3;
fi;

echo -e "$1 $HEAD_PHONES" >&${COPROC[1]}
sleep 3;

echo -e 'exit' >&${COPROC[1]}
echo $(cat <&${COPROC[0]}) > /tmp/headphones.log

if [[ "$1" == "connect" ]]; then
  NEW_SINK=`pacmd list-sinks | grep -zoP 'index[:] ([0-9]+).*\n.*bluez.*' | head -n 1 | awk -F ': ' '{ print $2; }'`
  NEW_SOURCE=`pacmd list-sources | grep -zoP 'index[:] ([0-9]+).*\n.*bluez.*' | head -n 1 | awk -F ': ' '{ print $2; }'`

  /usr/bin/pacmd set-default-sink $NEW_SINK
  /usr/bin/pacmd set-default-source $NEW_SOURCE

  /usr/bin/pacmd list-sink-inputs | grep index | awk -F ': ' '{ print $2; }' | xargs -I % /usr/bin/pacmd move-sink-input % $NEW_SINK
fi;

